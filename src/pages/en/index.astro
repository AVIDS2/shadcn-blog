---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostCard from "../../components/PostCard.astro";
import HeroEffectHost from "../../components/hero-effects/HeroEffectHost.astro";
import { heroEffects } from "../../config/hero-effects";
import {
  getAllTagsWithCount,
  getPublishedPosts,
  formatTagForPath,
} from "../../utils/posts";
import { withLocalePrefix, type SiteLocale } from "../../utils/i18n";

const locale: SiteLocale = "en-US";
const posts = await getPublishedPosts(locale);
const latestPosts = posts.slice(0, 6);
const tags = (await getAllTagsWithCount(locale)).slice(0, 12);
const featured = posts[0];
const latestPrimary = latestPosts.slice(0, 1);
const latestMore = latestPosts.slice(1);
---

<BaseLayout
  title="DWILL Blog"
  description="A static engineering blog focused on performance, architecture, and long-term maintainability."
>
  <section class="home-hero-wrap">
    <HeroEffectHost effect={heroEffects.active} locale={locale} />
  </section>

  <div class="home-content-shell">
    <section class="surface-inline-grid surface-inline-grid-3" aria-label="System overview">
      <article class="surface-card surface-card-fixed">
        <p class="surface-kicker">Writing & Publishing</p>
        <h3>Markdown-first</h3>
        <p>Articles are authored in Markdown and shipped as static pages.</p>
        <div class="surface-meta-row">
          <span>{posts.length} posts</span>
          <span>{tags.length} tags</span>
        </div>
      </article>

      <article class="surface-card surface-card-fixed">
        <p class="surface-kicker">URL Structure</p>
        <h3>Reference-safe paths</h3>
        <p>Posts and tags keep deterministic URLs for sharing and indexing.</p>
      </article>

      <article class="surface-card surface-card-fixed">
        <p class="surface-kicker">Delivery</p>
        <h3>Commit to publish</h3>
        <p>Write locally, push to Git, build, and deploy with a clear pipeline.</p>
      </article>
    </section>

    <section class="home-main-grid">
      <div class="home-main-col">
        <section class="section-stack">
          <div class="section-head">
            <h2>Latest Writing</h2>
            <a href="/en/posts/">View all</a>
          </div>
          <section class="post-list">
            {latestPrimary.map((post) => <PostCard post={post} locale={locale} />)}
          </section>
        </section>
      </div>

      <aside class="home-side-col" aria-label="Highlights">
        {
          featured && (
            <section class="section-stack">
              <div class="section-head">
                <h2>Featured</h2>
                <a href={withLocalePrefix(`/posts/${featured.data.translationKey}/`, locale)}>Read</a>
              </div>
              <section class="post-list">
                <PostCard post={featured} locale={locale} />
              </section>
            </section>
          )
        }
      </aside>
    </section>

    {
      latestMore.length > 0 && (
        <section class="section-stack">
          <div class="section-head">
            <h2>More Writing</h2>
            <a href="/en/posts/">Browse all</a>
          </div>
          <section class="post-grid">
            {latestMore.map((post) => <PostCard post={post} locale={locale} />)}
          </section>
        </section>
      )
    }

    {
      tags.length > 0 && (
        <section class="section-stack section-stack-wide">
          <div class="section-head">
            <h2>Popular Tags</h2>
            <a href="/en/tags/">Explore</a>
          </div>
          <article class="surface-card">
            <ul class="tag-cloud" aria-label="Popular tags">
              {tags.map(([tag, count]) => (
                <li>
                  <a href={`/en/tags/${formatTagForPath(tag)}/`}>
                    <span>#{tag}</span>
                    <small>{count}</small>
                  </a>
                </li>
              ))}
            </ul>
          </article>
        </section>
      )
    }
  </div>
</BaseLayout>
