---
import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";
import HeroEffectHost from "../components/hero-effects/HeroEffectHost.astro";
import { heroEffects } from "../config/hero-effects";
import {
  getAllTagsWithCount,
  getPublishedPosts,
  formatTagForPath,
} from "../utils/posts";
import { withLocalePrefix, type SiteLocale } from "../utils/i18n";

const locale: SiteLocale = "zh-CN";
const posts = await getPublishedPosts(locale);
const latestPosts = posts.slice(0, 6);
const tags = (await getAllTagsWithCount(locale)).slice(0, 12);
const featured = posts[0];
const latestPrimary = latestPosts.slice(0, 1);
const latestMore = latestPosts.slice(1);
---

<BaseLayout
  title="DWILL Blog"
  description="极简架构，高级质感，极致性能。A static engineering blog built for speed and long-term maintainability."
>
  <section class="home-hero-wrap">
    <HeroEffectHost effect={heroEffects.active} locale={locale} />
  </section>

  <div class="home-content-shell">
    <section class="surface-inline-grid surface-inline-grid-3" aria-label="System overview">
      <article class="surface-card surface-card-fixed">
        <p class="surface-kicker">写作与发布</p>
        <h3>Markdown 驱动</h3>
        <p>文章以 Markdown 维护，构建后直接发布为静态页面。</p>
        <div class="surface-meta-row">
          <span>{posts.length} 篇文章</span>
          <span>{tags.length} 个标签</span>
        </div>
      </article>

      <article class="surface-card surface-card-fixed">
        <p class="surface-kicker">链接结构</p>
        <h3>可引用路径</h3>
        <p>文章与标签使用固定 URL，便于分享、收录和长期引用。</p>
      </article>

      <article class="surface-card surface-card-fixed">
        <p class="surface-kicker">上线流程</p>
        <h3>提交即发布</h3>
        <p>本地写作、Git 提交、自动构建部署，流程清晰且可迁移。</p>
      </article>
    </section>

    <section class="home-main-grid">
      <div class="home-main-col">
        <section class="section-stack">
          <div class="section-head">
            <h2>最新写作</h2>
            <a href="/posts/">查看全部</a>
          </div>
          <section class="post-list">
            {latestPrimary.map((post) => <PostCard post={post} locale={locale} />)}
          </section>
        </section>
      </div>

      <aside class="home-side-col" aria-label="Highlights">
        {
          featured && (
            <section class="section-stack">
              <div class="section-head">
                <h2>精选</h2>
                <a href={withLocalePrefix(`/posts/${featured.data.translationKey}/`, locale)}>阅读</a>
              </div>
              <section class="post-list">
                <PostCard post={featured} locale={locale} />
              </section>
            </section>
          )
        }
      </aside>
    </section>

    {
      latestMore.length > 0 && (
        <section class="section-stack">
          <div class="section-head">
            <h2>更多文章</h2>
            <a href="/posts/">浏览全部</a>
          </div>
          <section class="post-grid">
            {latestMore.map((post) => <PostCard post={post} locale={locale} />)}
          </section>
        </section>
      )
    }

    {
      tags.length > 0 && (
        <section class="section-stack section-stack-wide">
          <div class="section-head">
            <h2>热门标签</h2>
            <a href="/tags/">探索</a>
          </div>
          <article class="surface-card">
            <ul class="tag-cloud" aria-label="Popular tags">
              {tags.map(([tag, count]) => (
                <li>
                  <a href={`/tags/${formatTagForPath(tag)}/`}>
                    <span>#{tag}</span>
                    <small>{count}</small>
                  </a>
                </li>
              ))}
            </ul>
          </article>
        </section>
      )
    }
  </div>
</BaseLayout>
