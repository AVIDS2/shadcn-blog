---
import SiteHeader from "../components/SiteHeader.astro";
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";
import { detectLocaleFromPath, type SiteLocale } from "../utils/i18n";

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: "website" | "article";
  noindex?: boolean;
  publishedTime?: string;
  modifiedTime?: string;
}

const {
  title = "DWILL Blog",
  description = "A lightweight high-performance static blog focused on engineering and product thinking.",
  image,
  type = "website",
  noindex = false,
  publishedTime,
  modifiedTime,
} = Astro.props;

const site = Astro.site ?? new URL("https://blog2.dwill.top");
const canonical = new URL(Astro.url.pathname, site);
const fullTitle = title.includes("DWILL") ? title : `${title} | DWILL Blog`;
const imageUrl = image ? new URL(image, site).toString() : undefined;
const locale: SiteLocale = detectLocaleFromPath(Astro.url.pathname);
const isZh = locale === "zh-CN";
const isHomePage = Astro.url.pathname === "/" || Astro.url.pathname === "/en/";
const rssHref = isZh ? "/rss.xml" : "/en/rss.xml";
---

<!doctype html>
<html lang={locale}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <meta name="author" content="DWILL" />
    <link rel="canonical" href={canonical.toString()} />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content="#0f1117" />
    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <meta property="og:type" content={type} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical.toString()} />
    <meta property="og:site_name" content="DWILL Blog" />
    {imageUrl && <meta property="og:image" content={imageUrl} />}
    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    {imageUrl && <meta name="twitter:image" content={imageUrl} />}

    <link rel="alternate" type="application/rss+xml" title="DWILL Blog RSS" href={rssHref} />
  </head>
  <body>
    <ClientRouter />
    <div class="site-shell">
      <SiteHeader />
      <main class:list={["container", "page-main", { "page-main-home": isHomePage }]}>
        <slot />
      </main>
      <footer class="site-footer">
        <div class="container footer-inner">
          <p>© {new Date().getFullYear()} DWILL Blog</p>
          <p>
            {
              isZh
                ? "Let's Build, let's Realize."
                : "Let's Build, let's Realize."
            }
          </p>
        </div>
      </footer>
    </div>
    <script is:inline>
      (() => {
        const STORAGE_KEY = "dwill_lang";
        const normalizeLang = (value) => (value === "zh-CN" ? "zh-CN" : "en-US");
        const getCurrentPath = () => window.location.pathname;
        const getCurrentLocale = () => {
          const path = getCurrentPath();
          return path === "/en" || path.startsWith("/en/") ? "en-US" : "zh-CN";
        };
        const toTargetPath = (locale) => {
          const currentPath = getCurrentPath();
          const zhOrEn = normalizeLang(locale);
          const target = zhOrEn === "en-US"
            ? (currentPath === "/" ? "/en/" : `/en${currentPath}`)
            : (currentPath.replace(/^\/en(?=\/|$)/, "") || "/");
          return target;
        };

        const init = () => {
          const currentPath = getCurrentPath();
          const currentLocale = getCurrentLocale();
          const switcher = document.querySelector("[data-lang-switch]");
          const saved = normalizeLang(localStorage.getItem(STORAGE_KEY) || currentLocale);
          localStorage.setItem(STORAGE_KEY, saved);

          if (switcher instanceof HTMLSelectElement) {
            switcher.value = currentLocale;
          }

          if (saved !== currentLocale) {
            const target = toTargetPath(saved);
            if (target !== currentPath) {
              window.location.replace(`${target}${window.location.search}${window.location.hash}`);
              return;
            }
          }

          if (switcher instanceof HTMLSelectElement) {
            if (switcher.dataset.langBound === "1") return;
            switcher.dataset.langBound = "1";
            switcher.addEventListener("change", () => {
              const targetLocale = normalizeLang(switcher.value);
              localStorage.setItem(STORAGE_KEY, targetLocale);
              const targetPath = toTargetPath(targetLocale);
              if (targetPath !== currentPath) {
                window.location.assign(`${targetPath}${window.location.search}${window.location.hash}`);
              }
            });
          }
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init, { once: true });
        } else {
          init();
        }
        document.addEventListener("astro:page-load", init);
      })();
    </script>
  </body>
</html>

